/*! jquery.pjaxr v1.1.0 | Copyright (c) 2013 Stephan Gross | MIT License | minddust.com */
(function(a){function c(a,d){return this.on("click.pjaxr",a,function(a){q(a,d)})}function w(b,d){if("string"===typeof b){var g=document.createElement("A");g.href=b;b=g}if("A"!==b.tagName.toUpperCase())throw"$.fn.pjaxr requires an anchor element";if((location.protocol===b.protocol&&location.hostname===b.hostname||":"===b.protocol&&""===b.hostname)&&(!b.hash||b.href.replace(b.hash,"")!==location.href.replace(location.hash,""))&&b.href!==location.href+"#"){var g={url:a.isFunction(b.href)?b.href():b.href,type:"GET",dataType:"html"},e=c.options=a.extend(!0,{},a.ajaxSettings,g,a.fn.pjaxr.defaults,d);n||(n=a("body").data("pjaxr-namespace")||"");var h;e.beforeSend=function(a,b){if(!k("pjaxr:beforeSend",[a,b]))return!1;a.setRequestHeader("X-PJAX","true");a.setRequestHeader("X-PJAX-NAMESPACE",n);0<b.timeout&&(h=setTimeout(function(){k("pjaxr:timeout",[a,e])&&a.abort("timeout")},b.timeout),b.timeout=0);return!0};c.state||(c.state={id:(new Date).getTime(),namespace:n,url:window.location.href,title:document.title},window.history.replaceState(c.state,c.state.title,c.state.url));(g=c.xhr)&&4>g.readyState&&(g.onreadystatechange=a.noop,g.abort());g=c.xhr=a.ajax(e);0<g.readyState&&k("pjaxr:start",[e]);g.done(function(b,g,f){k("pjaxr:success",[e]);var d="function"===typeof e.version?e.version():e.version,h=f.getResponseHeader("X-PJAX-Version");if(d&&h&&d!==h)u(e.url);else if(d=b.match(/<pjaxr-head>([\s\S.]*)<\/pjaxr-head>/i),h=b.match(/<pjaxr-body>([\s\S.]*)<\/pjaxr-body>/i),d||h){k("pjaxr:success",[b,g,f,e]);document.activeElement.blur();var D=(new Date).getTime();if(d)var p=a(a.parseHTML(d[0],document,!0)),r=x("forward",p.children(),null,null),p=r[0],s=r[1],r=r[2];if(h)var v=a(a.parseHTML(h[0],document,!0)),t=y(v.children()),v=t[0],t=t[1];var q=b.match(/<pjaxr-namespace>([\s\S.]*)<\/pjaxr-namespace>/i);q&&(n=a(a.parseHTML(q[0],document,!0)).html());a(document).find("input[autofocus], textarea[autofocus]").last().focus();"number"===typeof e.scrollTo&&a(window).scrollTop(e.scrollTo);a.extend(c.state,{head_revert:d?s:null,head_remove:d?r:null,body_revert:h?t:null});(e.push||e.replace)&&window.history.replaceState(c.state,c.state.title,c.state.url);c.state={id:D,namespace:n,url:e.url,title:document.title,head_apply:d?p:null,body_apply:h?v:null};e.push?window.history.pushState(c.state,c.state.title,c.state.url):e.replace&&window.history.replaceState(c.state,c.state.title,c.state.url);k("pjaxr:done",[b,g,f,e])}else u(e.url)});g.fail(function(a,b,d){"abort"!==b&&k("pjaxr:fail",[a,b,d,e])&&u(e.url)});g.always(function(){h&&clearTimeout(h);k("pjaxr:always",[e]);k("pjaxr:end",[e])})}}function q(a,d){var g=a.currentTarget;if("A"!==g.tagName.toUpperCase())throw"$.fn.pjaxr requires an anchor element";1<a.which||a.metaKey||a.ctrlKey||a.shiftKey||a.altKey||a.isDefaultPrevented()||(k("pjaxr:click")&&w(g,d),a.preventDefault())}function p(b,d){var g=[],e=[],c=[];b&&0<b.length&&a.each(b,function(b,m){var f=a(m);if(f.is("title"))document.title=f.text();else if(f.is("meta")){var l,k=f.attr("name"),n=f.attr("property");k?l=a('head > meta[name="'+k+'"]'):n&&(l=a('head > meta[property="'+n+'"]'));0<l.length?(c.push(h(l)),l.remove()):e.push(h(f));!0===d&&(a("head").append(f),g.push(h(f)))}else if(f.is("link")){if(l=f.attr("href"))l=a('head > link[href="'+l+'"]'),0<l.length?(c.push(h(l)),l.remove()):e.push(h(f)),!0===d&&(a("head").append(f),g.push(h(f)))}else if(f.is("script")){if(l=f.attr("src"))l=a('head > script[src="'+l+'"]'),0<l.length?(c.push(h(l)),l.remove()):e.push(h(f)),!0===d&&(a("head").append(f),g.push(h(f)))}else f.is("style")&&!0===d&&(a("head").append(f),g.push(h(f)),e.push(h(f)))});return[g,e,c]}function x(b,d,g,e){var c=[],k=[],m=[];"forward"===b?a("head > [data-remove-on-pjaxr]").each(function(){var b=a(this);m.push(h(b));b.remove()}):"back"===b&&(b=p(g,!1),e=p(e,!0),a.extend(k,b[1]),a.extend(m,e[2]));d=p(d,!0);a.extend(c,d[0]);a.extend(k,d[1]);a.extend(m,d[2]);return[c,k,m]}function y(b){var d=[],c=[];b&&0<b.length&&a.each(b,function(b,k){var n=a(k),m=n.attr("id");if(m&&(m=a("#"+m),0<m.length)){c.push(h(m));try{m.html(n.html())}catch(f){window.console&&console.error(f)}d.push(h(m))}});return[d,c]}function k(b,d){var c=a.Event(b);a(document).trigger(c,d);return!c.isDefaultPrevented()}function h(a){return a.clone().wrap("<p>").parent().html()}function u(a){window.history.replaceState(null,"","#");window.location.replace(a)}function z(a){if(a=a.state){if(s&&E==a.url)return;k("pjaxr:start",[c.options]);document.title=a.title;var d=c.state.id<a.id?"forward":"back";x(d,a.head_apply,a.head_revert,a.head_remove);(d="forward"===d?a.body_apply:a.body_revert)&&0<d.length&&y(d);c.state=a;n=a.namespace;document.body.offsetHeight;k("pjaxr:end",[c.options])}s=!1}function F(){return a("meta").filter(function(){return"X-PJAX-VERSION"===String(a(this).attr("http-equiv")).toUpperCase()}).attr("content")}function A(){a.fn.pjaxr=c;a.fn.pjaxr.click=q;a.fn.pjaxr.request=w;a.fn.pjaxr.enable=a.noop;a.fn.pjaxr.disable=B;a.fn.pjaxr.defaults={timeout:650,push:!0,replace:!1,scrollTo:0,version:F};a(window).on("popstate.pjaxr",z)}function B(){a.fn.pjaxr=function(){return this};a.fn.pjaxr.enable=A;a.fn.pjaxr.disable=a.noop;a(window).off("popstate.pjaxr",z)}var s=!0,E=window.location.href,C=window.history.state,n;C&&(c.state=C);"state"in window.history&&(s=!1);0>a.inArray("state",a.event.props)&&a.event.props.push("state");a.support.pjaxr=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/);a.support.pjaxr?A():B()})(jQuery);